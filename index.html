<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario de Ropa ‚Äî por Producto</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .option-btn { transition: all 0.2s; }
    .option-btn:hover { transform: scale(1.05); }
    .option-btn.selected { outline: 3px solid #1e40af; }
    input[type="number"]::-webkit-inner-spin-button { opacity: 1; }
    .matrix-table input { width: 4rem; text-align: center; }
    .product-list { scrollbar-width: thin; }
    .product-list::-webkit-scrollbar { width: 6px; }
    .product-list::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 3px; }
    [aria-current="true"] { background: #dbeafe; border-left: 4px solid #3b82f6; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">
  <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">Inventario de Ropa ‚Äî por Producto</h1>
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-4">
    <!-- Sidebar -->
    <aside class="bg-white rounded-xl shadow-sm p-4">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Productos</h2>
      <div class="flex gap-2 mb-3">
        <input id="nuevoProductoNombre" type="text" placeholder="Ej: SHORT SAPLEX JASPEADO" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="Nombre del nuevo producto">
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500" onclick="crearProducto()">+ Crear</button>
      </div>
      <div class="flex flex-wrap gap-2 mb-3">
        <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="exportarCSVProducto()">CSV Producto</button>
        <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="exportarCSVTodo()">CSV Todo</button>
        <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="exportarPDFTodo()">PDF Todo</button>
      </div>
      <div class="product-list max-h-[50vh] overflow-auto border border-gray-200 rounded-lg" role="listbox" aria-label="Lista de productos">
        <div id="listaProductos"></div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500" onclick="borrarProductoActivo()">Borrar Producto</button>
        <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500" onclick="borrarTodoInventario()">Borrar Todo</button>
        <button class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 focus:ring-2 focus:ring-amber-500" onclick="document.getElementById('csv-upload').click()">Importar CSV</button>
        <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="importarCSV(this.files[0])" aria-label="Importar archivo CSV">
      </div>
    </aside>

    <!-- Main -->
    <main class="bg-white rounded-xl shadow-sm p-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Form Meta -->
        <section class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold text-gray-800">Producto Activo</h3>
            <span id="badgeProducto" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">‚Äî</span>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block font-medium text-gray-700">Nombre del Producto</label>
              <input id="nombreProducto" placeholder="Ej: CALZA" list="nombresRecomendados" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Nombre del producto">
              <datalist id="nombresRecomendados">
                <option value="CALZA"><option value="BABUCHA"><option value="PANTALON">
                <option value="PALAZO"><option value="TOP"><option value="CAMPERA">
                <option value="BUZO"><option value="REMERA"><option value="CAMISETA">
              </datalist>
            </div>
            <div>
              <label class="block font-medium text-gray-700">Tela</label>
              <select id="telaProducto" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Material de la tela">
                <option value="">‚Äî</option>
                <option value="LYCRA">LYCRA</option>
                <option value="SAPLEX JASPEADO">SAPLEX JASPEADO</option>
                <option value="ALGODON CON LYCRA">ALGODON CON LYCRA</option>
                <option value="RUSTICO">RUSTICO</option>
                <option value="MODAL">MODAL</option>
                <option value="MORLEY">MORLEY</option>
                <option value="JEAN">JEAN</option>
                <option value="CORDERITO">CORDERITO</option>
                <option value="JASPEADO">JASPEADO</option>
              </select>
            </div>
            <div>
              <label class="block font-medium text-gray-700">Temporada</label>
              <div class="flex flex-wrap gap-2" id="tempBtns">
                <button class="option-btn bg-blue-600 text-white px-4 py-2 rounded-lg flex flex-col items-center" onclick="uiTemporada('Verano',this)" aria-label="Seleccionar Verano"><span class="icon text-xl">‚òÄ</span>Verano</button>
                <button class="option-btn bg-red-600 text-white px-4 py-2 rounded-lg flex flex-col items-center" onclick="uiTemporada('Invierno',this)" aria-label="Seleccionar Invierno"><span class="icon text-xl">‚ùÑ</span>Invierno</button>
                <button class="option-btn bg-yellow-400 text-gray-800 px-4 py-2 rounded-lg flex flex-col items-center" onclick="uiTemporada('Todo el a√±o',this)" aria-label="Seleccionar Todo el a√±o"><span class="icon text-xl">üìÖ</span>Todo el a√±o</button>
              </div>
            </div>
            <div>
              <label class="block font-medium text-gray-700">Tipo</label>
              <div class="flex flex-wrap gap-2" id="tipoBtns">
                <button class="option-btn bg-green-600 text-white px-4 py-2 rounded-lg flex flex-col items-center" onclick="uiTipo('Hombre',this)" aria-label="Seleccionar Hombre"><span class="icon text-xl">üë®</span>Hombre</button>
                <button class="option-btn bg-blue-600 text-white px-4 py-2 rounded-lg flex flex-col items-center" onclick="uiTipo('Mujer',this)" aria-label="Seleccionar Mujer"><span class="icon text-xl">üë©</span>Mujer</button>
                <button class="option-btn bg-red-600 text-white px-4 py-2 rounded-lg flex flex-col items-center" onclick="uiTipo('Ni√±o',this)" aria-label="Seleccionar Ni√±o"><span class="icon text-xl">üßí</span>Ni√±o</button>
              </div>
            </div>
            <div>
              <label class="block font-medium text-gray-700">√öltima Actualizaci√≥n</label>
              <div id="lastUpdated" class="text-sm text-gray-500">‚Äî</div>
            </div>
            <button class="bg-green-600 text-white w-full py-2 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500" onclick="guardarMetaDesdeFormulario()">Guardar/Activar Producto</button>
            <p class="text-sm text-gray-500">Crea o edita el producto, luego usa la matriz r√°pida para agregar cantidades por color y talle.</p>
          </div>
        </section>

        <!-- Totales -->
        <section class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Totales</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3">
              <div class="text-sm text-gray-600">Total General</div>
              <div id="totGeneral" class="text-lg font-bold text-gray-800">0</div>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3">
              <div class="text-sm text-gray-600">Talles (T1..T8)</div>
              <div id="totTalles" class="text-sm text-gray-500">‚Äî</div>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3">
              <div class="text-sm text-gray-600">Colores (Top 5)</div>
              <div id="totColores" class="text-sm text-gray-500">‚Äî</div>
            </div>
          </div>
        </section>
      </div>

      <!-- Matriz R√°pida -->
      <section class="bg-gray-50 rounded-lg p-4 mt-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-gray-800">Matriz R√°pida (Color √ó Talles 1..8)</h3>
          <button class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500" onclick="aplicarMatriz()">Agregar al Inventario</button>
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label class="block font-medium text-gray-700">Color</label>
            <input id="matColor" placeholder="Ej: gris" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" list="coloresRecomendados" aria-label="Color para la matriz">
            <datalist id="coloresRecomendados">
              <option value="negro"><option value="azul marino"><option value="francia">
              <option value="bordo"><option value="melange"><option value="topo">
            </datalist>
          </div>
          <div class="flex-1">
            <label class="block font-medium text-gray-700">Accesos R√°pidos</label>
            <div class="flex flex-wrap gap-2">
              <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="rellenarFila(0)">Vaciar</button>
              <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="rellenarFila(1)">1 en todos</button>
              <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="rellenarFila(2)">2 en todos</button>
              <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="rellenarFila(5)">5 en todos</button>
            </div>
          </div>
        </div>
        <div class="overflow-auto mt-3">
          <table class="matrix-table w-full border-collapse">
            <thead>
              <tr>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Talle</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T1</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T2</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T3</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T4</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T5</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T6</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T7</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">T8</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th class="border border-gray-200 bg-gray-50 p-2">Cant.</th>
                <td class="border border-gray-200 p-1"><input id="t1" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 1"></td>
                <td class="border border-gray-200 p-1"><input id="t2" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 2"></td>
                <td class="border border-gray-200 p-1"><input id="t3" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 3"></td>
                <td class="border border-gray-200 p-1"><input id="t4" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 4"></td>
                <td class="border border-gray-200 p-1"><input id="t5" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 5"></td>
                <td class="border border-gray-200 p-1"><input id="t6" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 6"></td>
                <td class="border border-gray-200 p-1"><input id="t7" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 7"></td>
                <td class="border border-gray-200 p-1"><input id="t8" type="number" min="0" value="0" class="p-1 border rounded" aria-label="Cantidad Talle 8"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-sm text-gray-500 mt-2">Ingresa cantidades por talle y color, luego agr√©galas al inventario. Usa valores negativos para correcciones.</p>
      </section>

      <!-- Tabla Producto -->
      <section class="bg-gray-50 rounded-lg p-4 mt-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-gray-800">Detalle del Producto</h3>
          <div class="flex gap-2">
            <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="exportarPDFProducto()">PDF Producto</button>
            <button class="bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-lg hover:bg-blue-50 focus:ring-2 focus:ring-blue-500" onclick="exportarCSVProducto()">CSV Producto</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Color</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Talle</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Cantidad</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Tela</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Temporada</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Tipo</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">√öltima Actualizaci√≥n</th>
                <th class="border border-gray-200 bg-blue-600 text-white p-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="cuerpoProducto"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
    let productoActivo = null;
    let temporadaSel = '';
    let tipoSel = '';

    // Utilidades
    const gid = () => '_' + Math.random().toString(36).slice(2, 11);
    const save = () => localStorage.setItem('inventario', JSON.stringify(inventario));
    const formatDate = (date) => new Date(date).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
    const productosUnicos = () => Array.from(new Set(inventario.map(p => (p.nombre || '').trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b));
    const filtrarPorProducto = (n) => inventario.filter(p => p.nombre === n);
    const getMeta = (n) => {
      const p = inventario.find(x => x.nombre === n);
      return { tela: p?.tela || '', temporada: p?.temporada || '', tipo: p?.tipo || '', lastUpdated: p?.lastUpdated || '' };
    };

    // Sidebar
    function renderProductos() {
      const cont = document.getElementById('listaProductos');
      cont.innerHTML = '';
      const lista = productosUnicos();
      if (!lista.length) {
        cont.innerHTML = '<div class="text-gray-500 text-sm p-3">No hay productos. Crea uno.</div>';
        return;
      }
      lista.forEach(nom => {
        const items = filtrarPorProducto(nom);
        const total = items.reduce((s, x) => s + (parseInt(x.cantidad) || 0), 0);
        const lastUpdated = items.reduce((latest, x) => {
          const date = x.lastUpdated ? new Date(x.lastUpdated) : new Date(0);
          return date > latest ? date : latest;
        }, new Date(0));
        const div = document.createElement('div');
        div.className = 'product-item p-3 flex justify-between items-center cursor-pointer';
        div.setAttribute('role', 'option');
        div.setAttribute('aria-current', productoActivo === nom ? 'true' : 'false');
        div.tabIndex = 0;
        div.onclick = () => setProductoActivo(nom);
        div.onkeydown = (e) => e.key === 'Enter' && setProductoActivo(nom);
        div.innerHTML = `
          <div>
            <div class="font-semibold">${nom}</div>
            <div class="text-sm text-gray-500">${items.length} l√≠neas ‚Ä¢ Total: ${total} ‚Ä¢ √öltima: ${lastUpdated.getTime() ? formatDate(lastUpdated) : '‚Äî'}</div>
          </div>
          <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${getMeta(nom).tela || '‚Äî'}</span>
        `;
        cont.appendChild(div);
      });
    }

    function crearProducto() {
      const nom = (document.getElementById('nuevoProductoNombre').value || '').trim();
      if (!nom) {
        alert('Ingresa un nombre de producto.');
        return;
      }
      if (!productosUnicos().includes(nom)) {
        inventario.push({ id: gid(), nombre: nom, cantidad: 0, color: '‚Äî', talle: '‚Äî', tela: '', temporada: '', tipo: '', lastUpdated: new Date().toISOString() });
        save();
      }
      setProductoActivo(nom);
      document.getElementById('nuevoProductoNombre').value = '';
      document.getElementById('nuevoProductoNombre').focus();
    }

    function setProductoActivo(nom) {
      productoActivo = nom;
      const meta = getMeta(nom);
      temporadaSel = meta.temporada || '';
      tipoSel = meta.tipo || '';
      renderProductos();
      renderMetaProducto();
      renderTablaProducto();
      renderTotales();
    }

    function borrarProductoActivo() {
      if (!productoActivo) {
        alert('No hay producto activo.');
        return;
      }
      if (confirm(`‚ö†Ô∏è Vas a borrar TODAS las l√≠neas del producto "${productoActivo}".\n\n¬øContinuar?`)) {
        inventario = inventario.filter(p => p.nombre !== productoActivo);
        save();
        productoActivo = null;
        renderProductos();
        renderMetaProducto();
        renderTablaProducto();
        renderTotales();
        alert('Producto borrado.');
      }
    }

    function borrarTodoInventario() {
      if (!inventario.length) {
        alert('El inventario ya est√° vac√≠o.');
        return;
      }
      if (confirm('‚ö†Ô∏è Atenci√≥n: vas a borrar TODO el inventario.\n\n¬øContinuar?')) {
        inventario = [];
        save();
        productoActivo = null;
        renderProductos();
        renderMetaProducto();
        renderTablaProducto();
        renderTotales();
        alert('Inventario borrado.');
      }
    }

    // UI Botones
    function clearSelected(container) {
      container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    }

    function uiTemporada(val, btn) {
      temporadaSel = val;
      clearSelected(document.getElementById('tempBtns'));
      btn.classList.add('selected');
    }

    function uiTipo(val, btn) {
      tipoSel = val;
      clearSelected(document.getElementById('tipoBtns'));
      btn.classList.add('selected');
    }

    // Form Meta
    function renderMetaProducto() {
      const badge = document.getElementById('badgeProducto');
      const nom = document.getElementById('nombreProducto');
      const tela = document.getElementById('telaProducto');
      const lastUpdated = document.getElementById('lastUpdated');
      clearSelected(document.getElementById('tempBtns'));
      clearSelected(document.getElementById('tipoBtns'));

      if (!productoActivo) {
        badge.textContent = '‚Äî';
        nom.value = '';
        tela.value = '';
        temporadaSel = '';
        tipoSel = '';
        lastUpdated.textContent = '‚Äî';
        return;
      }

      const meta = getMeta(productoActivo);
      badge.textContent = productoActivo;
      nom.value = productoActivo;
      tela.value = meta.tela || '';
      lastUpdated.textContent = meta.lastUpdated ? formatDate(meta.lastUpdated) : '‚Äî';
      if (meta.temporada) {
        const map = { 'Verano': 0, 'Invierno': 1, 'Todo el a√±o': 2 };
        document.getElementById('tempBtns').children[map[meta.temporada]]?.classList.add('selected');
        temporadaSel = meta.temporada;
      }
      if (meta.tipo) {
        const map = { 'Hombre': 0, 'Mujer': 1, 'Ni√±o': 2 };
        document.getElementById('tipoBtns').children[map[meta.tipo]]?.classList.add('selected');
        tipoSel = meta.tipo;
      }
    }

    function guardarMetaDesdeFormulario() {
      const nuevoNombre = (document.getElementById('nombreProducto').value || '').trim();
      const tela = document.getElementById('telaProducto').value;
      if (!nuevoNombre) {
        alert('El nombre del producto no puede estar vac√≠o.');
        return;
      }

      if (!productosUnicos().includes(nuevoNombre)) {
        inventario.push({ id: gid(), nombre: nuevoNombre, cantidad: 0, color: '‚Äî', talle: '‚Äî', tela: '', temporada: '', tipo: '', lastUpdated: new Date().toISOString() });
      }

      if (productoActivo && productoActivo !== nuevoNombre) {
        inventario.forEach(p => { if (p.nombre === productoActivo) { p.nombre = nuevoNombre; p.lastUpdated = new Date().toISOString(); } });
        productoActivo = nuevoNombre;
      } else if (!productoActivo) {
        productoActivo = nuevoNombre;
      }

      inventario.forEach(p => {
        if (p.nombre === productoActivo) {
          p.tela = tela;
          p.temporada = temporadaSel || '';
          p.tipo = tipoSel || '';
          p.lastUpdated = new Date().toISOString();
        }
      });
      save();
      renderProductos();
      renderMetaProducto();
      renderTablaProducto();
      renderTotales();
      document.getElementById('nombreProducto').focus();
    }

    // Matriz R√°pida
    function rellenarFila(v) {
      for (let i = 1; i <= 8; i++) {
        document.getElementById('t' + i).value = v;
      }
    }

    function aplicarMatriz() {
      if (!productoActivo) {
        alert('Primero guarda/activa el producto.');
        return;
      }
      const color = (document.getElementById('matColor').value || '').trim();
      if (!color) {
        alert('Ingresa un color.');
        return;
      }
      const meta = getMeta(productoActivo);
      let agregadas = 0;
      for (let i = 1; i <= 8; i++) {
        const v = parseInt(document.getElementById('t' + i).value || '0', 10);
        if (!isNaN(v) && v !== 0) {
          inventario.push({ id: gid(), nombre: productoActivo, cantidad: v, color, talle: String(i), tela: meta.tela || '', temporada: meta.temporada || '', tipo: meta.tipo || '', lastUpdated: new Date().toISOString() });
          agregadas++;
        }
      }
      if (!agregadas) {
        alert('No hay cantidades para agregar.');
        return;
      }
      save();
      renderTablaProducto();
      renderTotales();
      document.getElementById('matColor').value = '';
      rellenarFila(0);
      document.getElementById('matColor').focus();
    }

    // Tabla Producto
    function renderTablaProducto() {
      const cuerpo = document.getElementById('cuerpoProducto');
      cuerpo.innerHTML = '';
      if (!productoActivo) {
        cuerpo.innerHTML = '<tr><td colspan="8" class="text-gray-500 text-sm p-3">No hay l√≠neas. Usa la matriz r√°pida.</td></tr>';
        return;
      }
      const filas = filtrarPorProducto(productoActivo).filter(x => !(x.color === '‚Äî' && x.talle === '‚Äî'));
      if (!filas.length) {
        cuerpo.innerHTML = '<tr><td colspan="8" class="text-gray-500 text-sm p-3">No hay l√≠neas. Usa la matriz r√°pida.</td></tr>';
        return;
      }
      filas.sort((a, b) => a.color.toLowerCase() === b.color.toLowerCase() ? ((parseInt(a.talle) || 0) - (parseInt(b.talle) || 0)) : a.color.localeCompare(b.color));
      filas.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border border-gray-200 p-2">${p.color}</td>
          <td class="border border-gray-200 p-2">${p.talle}</td>
          <td class="border border-gray-200 p-2"><input type="number" min="-9999" value="${p.cantidad}" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" onchange="editarCantidad('${p.id}',this.value)" aria-label="Cantidad para ${p.color} talle ${p.talle}"></td>
          <td class="border border-gray-200 p-2">${p.tela || '‚Äî'}</td>
          <td class="border border-gray-200 p-2">${p.temporada || '‚Äî'}</td>
          <td class="border border-gray-200 p-2">${p.tipo || '‚Äî'}</td>
          <td class="border border-gray-200 p-2">${p.lastUpdated ? formatDate(p.lastUpdated) : '‚Äî'}</td>
          <td class="border border-gray-200 p-2"><button class="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500" onclick="eliminarLinea('${p.id}')" aria-label="Eliminar l√≠nea">Eliminar</button></td>
        `;
        cuerpo.appendChild(tr);
      });
    }

    function editarCantidad(id, val) {
      const n = parseInt(val, 10);
      if (isNaN(n)) {
        alert('Cantidad inv√°lida');
        renderTablaProducto();
        return;
      }
      const i = inventario.findIndex(p => p.id === id);
      if (i >= 0) {
        inventario[i].cantidad = n;
        inventario[i].lastUpdated = new Date().toISOString();
        save();
        renderProductos();
        renderMetaProducto();
        renderTotales();
      }
    }

    function eliminarLinea(id) {
      if (!confirm('¬øEliminar esta l√≠nea?')) return;
      inventario = inventario.filter(p => p.id !== id);
      save();
      renderProductos();
      renderTablaProducto();
      renderTotales();
    }

    // Totales
    function renderTotales() {
      const tg = document.getElementById('totGeneral');
      const tt = document.getElementById('totTalles');
      const tc = document.getElementById('totColores');
      if (!productoActivo) {
        tg.textContent = '0';
        tt.textContent = '‚Äî';
        tc.textContent = '‚Äî';
        return;
      }
      const filas = filtrarPorProducto(productoActivo).filter(x => !(x.color === '‚Äî' && x.talle === '‚Äî'));
      const total = filas.reduce((s, x) => s + (parseInt(x.cantidad) || 0), 0);
      tg.textContent = String(total);
      const porTalle = {}, porColor = {};
      filas.forEach(x => {
        porTalle[x.talle] = (porTalle[x.talle] || 0) + (parseInt(x.cantidad) || 0);
        porColor[x.color] = (porColor[x.color] || 0) + (parseInt(x.cantidad) || 0);
      });
      tt.textContent = Array.from({ length: 8 }, (_, i) => `T${i + 1}:${porTalle[i + 1] || 0}`).join(' ‚Ä¢ ');
      const top = Object.entries(porColor).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([c, v]) => `${c}:${v}`);
      tc.textContent = top.length ? top.join(' ‚Ä¢ ') : '‚Äî';
    }

    // Export/Import
    function exportarCSVProducto() {
      if (!productoActivo) {
        alert('Selecciona un producto.');
        return;
      }
      const filas = filtrarPorProducto(productoActivo).filter(x => !(x.color === '‚Äî' && x.talle === '‚Äî'));
      if (!filas.length) {
        alert('No hay datos para exportar.');
        return;
      }
      let csv = 'Nombre|Cantidad|Color|Talle|Tela|Temporada|Tipo|√öltima Actualizaci√≥n\n';
      filas.forEach(p => {
        csv += `${p.nombre}|${p.cantidad}|${p.color}|${p.talle}|${p.tela || ''}|${p.temporada || ''}|${p.tipo || ''}|${p.lastUpdated ? formatDate(p.lastUpdated) : ''}\n`;
      });
      descargarCSV(csv, `${productoActivo.replace(/\s+/g, '_').toLowerCase()}.csv`);
    }

    function exportarCSVTodo() {
      if (!inventario.length) {
        alert('No hay datos para exportar.');
        return;
      }
      let csv = 'Nombre|Cantidad|Color|Talle|Tela|Temporada|Tipo|√öltima Actualizaci√≥n\n';
      inventario.forEach(p => {
        if (p.color === '‚Äî' && p.talle === '‚Äî') return;
        csv += `${p.nombre}|${p.cantidad}|${p.color}|${p.talle}|${p.tela || ''}|${p.temporada || ''}|${p.tipo || ''}|${p.lastUpdated ? formatDate(p.lastUpdated) : ''}\n`;
      });
      descargarCSV(csv, 'inventario_completo.csv');
    }

    function exportarPDFProducto() {
      if (!productoActivo) {
        alert('Selecciona un producto.');
        return;
      }
      const filas = filtrarPorProducto(productoActivo).filter(x => !(x.color === '‚Äî' && x.talle === '‚Äî'));
      if (!filas.length) {
        alert('No hay datos para exportar.');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait' });
      doc.setFontSize(16);
      doc.text(`Inventario ‚Äî ${productoActivo}`, 20, 20);
      const meta = getMeta(productoActivo);
      doc.setFontSize(12);
      doc.text(`Tela: ${meta.tela || '‚Äî'} | Temporada: ${meta.temporada || '‚Äî'} | Tipo: ${meta.tipo || '‚Äî'}`, 20, 30);
      doc.text(`√öltima Actualizaci√≥n: ${meta.lastUpdated ? formatDate(meta.lastUpdated) : '‚Äî'}`, 20, 40);
      const total = filas.reduce((s, x) => s + (parseInt(x.cantidad) || 0), 0);
      doc.text(`Total: ${total} unidades`, 20, 50);
      const tableData = filas.map(p => [p.color, p.talle, p.cantidad, p.tela || '‚Äî', p.temporada || '‚Äî', p.tipo || '‚Äî', p.lastUpdated ? formatDate(p.lastUpdated) : '‚Äî']);
      doc.autoTable({
        head: [['Color', 'Talle', 'Cantidad', 'Tela', 'Temporada', 'Tipo', '√öltima Actualizaci√≥n']],
        body: tableData,
        startY: 60,
        theme: 'striped',
        styles: { fontSize: 10, cellPadding: 4 },
        headStyles: { fillColor: [59, 130, 246], textColor: [255, 255, 255], fontSize: 11 }
      });
      doc.save(`${productoActivo.replace(/\s+/g, '_').toLowerCase()}.pdf`);
    }

    function exportarPDFTodo() {
      if (!inventario.length) {
        alert('No hay datos para exportar.');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait' });
      doc.setFontSize(16);
      doc.text('Inventario Completo de Ropa', 20, 20);
      doc.setFontSize(12);
      doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
      let startY = 40;
      const productos = productosUnicos();
      productos.forEach((nom, index) => {
        const filas = filtrarPorProducto(nom).filter(x => !(x.color === '‚Äî' && x.talle === '‚Äî'));
        if (!filas.length) return;
        doc.setFontSize(14);
        doc.text(nom, 20, startY);
        const meta = getMeta(nom);
        doc.setFontSize(10);
        doc.text(`Tela: ${meta.tela || '‚Äî'} | Temporada: ${meta.temporada || '‚Äî'} | Tipo: ${meta.tipo || '‚Äî'}`, 20, startY + 7);
        doc.text(`√öltima Actualizaci√≥n: ${meta.lastUpdated ? formatDate(meta.lastUpdated) : '‚Äî'}`, 20, startY + 14);
        const total = filas.reduce((s, x) => s + (parseInt(x.cantidad) || 0), 0);
        doc.text(`Total: ${total} unidades`, 20, startY + 21);
        const tableData = filas.map(p => [p.color, p.talle, p.cantidad, p.tela || '‚Äî', p.temporada || '‚Äî', p.tipo || '‚Äî', p.lastUpdated ? formatDate(p.lastUpdated) : '‚Äî']);
        doc.autoTable({
          head: [['Color', 'Talle', 'Cantidad', 'Tela', 'Temporada', 'Tipo', '√öltima Actualizaci√≥n']],
          body: tableData,
          startY: startY + 27,
          theme: 'striped',
          styles: { fontSize: 10, cellPadding: 4 },
          headStyles: { fillColor: [59, 130, 246], textColor: [255, 255, 255], fontSize: 11 }
        });
        startY = doc.lastAutoTable.finalY + 20;
        if (index < productos.length - 1 && startY > 250) {
          doc.addPage();
          startY = 20;
        }
      });
      doc.save('inventario_completo.pdf');
    }

    function descargarCSV(csv, nombre) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = nombre;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function importarCSV(file) {
      if (!file) {
        alert('No se seleccion√≥ archivo.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split('\n').filter(l => l.trim() !== '');
        let ok = 0;
        lines.forEach((line, i) => {
          if (i === 0) return;
          const seps = [',', '|'];
          let p = null;
          for (const s of seps) {
            p = line.split(s).map(x => x.trim());
            if (p.length >= 7) break;
          }
          if (!p || p.length < 7) return;
          const [nombre, cantStr, color, talle, tela, temporada, tipo, lastUpdated = new Date().toISOString()] = p;
          const cantidad = parseInt(cantStr, 10);
          if (!nombre || isNaN(cantidad) || !color || !talle) return;
          inventario.push({ id: gid(), nombre, cantidad, color, talle, tela, temporada, tipo, lastUpdated });
          ok++;
        });
        if (!ok) {
          alert('No se importaron filas v√°lidas.');
          return;
        }
        save();
        if (!productoActivo) {
          const lista = productosUnicos();
          if (lista.length) productoActivo = lista[0];
        }
        renderProductos();
        renderMetaProducto();
        renderTablaProducto();
        renderTotales();
        alert(`Importadas ${ok} l√≠neas.`);
      };
      reader.onerror = () => alert('Error al leer el archivo.');
      reader.readAsText(file);
    }

    // Inicio
    (function init() {
      const lista = productosUnicos();
      if (lista.length) {
        productoActivo = lista[0];
      }
      renderProductos();
      renderMetaProducto();
      renderTablaProducto();
      renderTotales();
      document.getElementById('nuevoProductoNombre').focus();
    })();
  </script>
</body>
</html>
